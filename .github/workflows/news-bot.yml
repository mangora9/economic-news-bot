# .github/workflows/news-bot.yml
name: "망고의 뉴스 BOT"

on:
  # 1시간마다 실행 (UTC 기준)
  schedule:
    - cron: "0 * * * *" # 매시 정각

  # 수동 실행 가능
  workflow_dispatch:

  # 테스트용: push시에도 실행 (나중에 제거 가능)
  push:
    branches: [main]

# 🆕 권한 설정 추가
permissions:
  contents: write # repository 내용 쓰기 권한
  actions: read # actions 읽기 권한

jobs:
  send-news:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        category: [economy, realestate]

    steps:
      # 1. 코드 체크아웃
      - name: 코드 가져오기
        uses: actions/checkout@v4
        with:
          # 🆕 개인 토큰 대신 GITHUB_TOKEN 사용
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Node.js 설정
      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 3. 의존성 설치
      - name: 패키지 설치
        run: npm install

      # 4. 뉴스봇 실행
      - name: 뉴스봇 실행 (${{ matrix.category }})
        env:
          SLACK_WEBHOOK_URL_ECONOMY: ${{ secrets.SLACK_WEBHOOK_URL_ECONOMY }}
          SLACK_WEBHOOK_URL_REALESTATE: ${{ secrets.SLACK_WEBHOOK_URL_REALESTATE }}
          NEWS_CATEGORY: ${{ matrix.category }}
        run: npm start

      # 5. 변경사항 커밋 (last_check.json 업데이트)
      - name: 확인 시간 기록 저장 (${{ matrix.category }})
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add last_check.json
          if ! git diff --staged --quiet; then
            git commit -m "⏰ ${{ matrix.category }} 뉴스 확인 - $(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M')"
            git push
          else
            echo "변경사항 없음"
          fi
