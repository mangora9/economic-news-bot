# .github/workflows/news-bot.yml
name: "망고의 뉴스 BOT"

on:
  # 1시간마다 실행 (한국시간 매시 정각 = UTC -9시간)
  schedule:
    - cron: "0 15-23,0-14 * * *" # 한국시간 매시 정각 (UTC 15시~14시)

  # 수동 실행 가능
  workflow_dispatch:

  # 테스트용: push시에도 실행 (나중에 제거 가능)
  push:
    branches: [main]

# 권한 설정
permissions:
  actions: read # actions 읽기 권한

jobs:
  send-news:
    runs-on: ubuntu-latest

    steps:
      # 1. 코드 체크아웃
      - name: 코드 가져오기
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Node.js 설정
      - name: Node.js 설정
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 3. 의존성 설치
      - name: 패키지 설치
        run: npm install

      # 3.5. 캐시에서 마지막 확인 시간 복원
      - name: 마지막 확인 시간 캐시 복원
        uses: actions/cache@v3
        with:
          path: last_check.json
          key: news-bot-last-check-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            news-bot-last-check-${{ runner.os }}-
            news-bot-last-check-

      # 4. 경제뉴스 실행
      - name: 경제뉴스 전송
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          NEWS_CATEGORY: economy
        run: npm start

      # 5. 부동산뉴스 실행
      - name: 부동산뉴스 전송
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          NEWS_CATEGORY: realestate
        run: npm start

      # 6. 긱뉴스 실행
      - name: 긱뉴스 전송
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
          NEWS_CATEGORY: geeknews
        run: npm start

      # 7. 마지막 확인 시간 캐시 저장
      - name: 마지막 확인 시간 캐시 저장
        uses: actions/cache/save@v3
        if: always()
        with:
          path: last_check.json
          key: news-bot-last-check-${{ runner.os }}-${{ hashFiles('**/package-lock.json') }}-${{ github.run_id }}
