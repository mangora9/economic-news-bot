# .github/workflows/news-bot.yml
name: "ë§ê³ ì˜ ë‰´ìŠ¤ BOT"

on:
  # 1ì‹œê°„ë§ˆë‹¤ ì‹¤í–‰ (UTC ê¸°ì¤€)
  schedule:
    - cron: "0 * * * *" # ë§¤ì‹œ ì •ê°

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

  # í…ŒìŠ¤íŠ¸ìš©: pushì‹œì—ë„ ì‹¤í–‰ (ë‚˜ì¤‘ì— ì œê±° ê°€ëŠ¥)
  push:
    branches: [main]

# ğŸ†• ê¶Œí•œ ì„¤ì • ì¶”ê°€
permissions:
  contents: write # repository ë‚´ìš© ì“°ê¸° ê¶Œí•œ
  actions: read # actions ì½ê¸° ê¶Œí•œ

jobs:
  send-news:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        category: [economy, realestate]

    steps:
      # 1. ì½”ë“œ ì²´í¬ì•„ì›ƒ
      - name: ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        uses: actions/checkout@v4
        with:
          # ğŸ†• ê°œì¸ í† í° ëŒ€ì‹  GITHUB_TOKEN ì‚¬ìš©
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. Node.js ì„¤ì •
      - name: Node.js ì„¤ì •
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      # 3. ì˜ì¡´ì„± ì„¤ì¹˜
      - name: íŒ¨í‚¤ì§€ ì„¤ì¹˜
        run: npm install

      # 4. ë‰´ìŠ¤ë´‡ ì‹¤í–‰
      - name: ë‰´ìŠ¤ë´‡ ì‹¤í–‰ (${{ matrix.category }})
        env:
          SLACK_WEBHOOK_URL_ECONOMY: ${{ secrets.SLACK_WEBHOOK_URL_ECONOMY }}
          SLACK_WEBHOOK_URL_REALESTATE: ${{ secrets.SLACK_WEBHOOK_URL_REALESTATE }}
          NEWS_CATEGORY: ${{ matrix.category }}
        run: npm start

      # 5. ë³€ê²½ì‚¬í•­ ì»¤ë°‹ (last_check.json ì—…ë°ì´íŠ¸)
      - name: í™•ì¸ ì‹œê°„ ê¸°ë¡ ì €ì¥ (${{ matrix.category }})
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add last_check.json
          if ! git diff --staged --quiet; then
            git commit -m "â° ${{ matrix.category }} ë‰´ìŠ¤ í™•ì¸ - $(TZ=Asia/Seoul date +'%Y-%m-%d %H:%M')"
            git push
          else
            echo "ë³€ê²½ì‚¬í•­ ì—†ìŒ"
          fi
